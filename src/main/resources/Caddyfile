{
    debug
    auto_https off
    ocsp_stapling off
}

(proxy_headers) {
    header_up Host                   {$OUTER_HOST}
    header_up X-ProxiedEntitiesChain {xpechain}
    header_up X-ProxiedIssuersChain  {xpichain}
}
(proxy_http) {
    transport http {
        tls_server_name              {$OUTER_HOST}
        tls_trusted_ca_certs         /certs/trust.pem
        tls_client_auth              /certs/test.crt /certs/test.key
    }
}

:8443 {
    tls /certs/test.crt /certs/test.key {
        client_auth {
            mode                   require_and_verify
            trusted_ca_cert_file   /certs/trust.pem
        }
    }
    map {header.X-ProxiedEntitiesChain} {xpechain} {
        ~^(.+)$ {header.X-ProxiedEntitiesChain}<{tls_client_subject}>
        default <{tls_client_subject}>
    }
    map {header.X-ProxiedIssuersChain} {xpichain} {
        ~^(.+)$ {header.X-ProxiedIssuersChain}<{tls_client_issuer}>
        default <{tls_client_issuer}>
    }
    handle /greeting-service/* {
        reverse_proxy https://greeting-service:8443 {
            import proxy_headers
            import proxy_http
        }
    }
}
